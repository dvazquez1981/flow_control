<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/listado-dispositivos"></ion-back-button>
    </ion-buttons>
    <ion-title>Detalle Dispositivo</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content *ngIf="dispositivo" class="ion-padding">

  <!-- Datos del dispositivo -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Dispositivo {{ dispositivo.dispositivoId }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Nombre:</strong> {{ dispositivo.nombre }}</p>
      <p><strong>Ubicación:</strong> {{ dispositivo.ubicacion }}</p>
      <p><strong>Tipo contador:</strong> {{ dispositivo.tipoContadorDescripcion }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Último comando -->
  <ion-card *ngIf="ultimoComando; else sinComando">
    <ion-card-header>
      <ion-card-title>Último Comando</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- <p><strong>ID:</strong> {{ ultimoComando.cmdId }}</p>-->
      <p><strong>Tipo de comando:</strong> {{ ultimoComando.tipoComandorDescripcion }}</p>
      <p><strong>Valor:</strong> {{ ultimoComando.valor }}</p>
      <p><strong>Fecha:</strong> {{ ultimoComando.fecha | fechaLocal }}</p>


      <!-- Respuesta asociada -->
      <div *ngIf="(respuestasUltimoComando ?? []).length > 0; else sinRespuestas">
        <h4>Respuesta asociada:</h4>
        <ion-list>
          <ion-item *ngFor="let resp of respuestasUltimoComando">
            <ion-label>
             <!-- <p><strong>ID:</strong> {{ resp.RespId }}</p>-->
              <p><strong>Valor:</strong> {{ resp.valor }}</p>
              <p><strong>Fecha:</strong> {{ ultimoComando.fecha  | fechaLocal }}</p>

            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <ng-template #sinRespuestas>
        <p class="text-muted">No hay respuesta asociada al último comando.</p>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- Sin comandos -->
  <ng-template #sinComando>
    <ion-card>
      <ion-card-header>
        <ion-card-title>Sin comandos</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>No hay comandos registrados aún para este dispositivo.</p>
      </ion-card-content>
    </ion-card>
  </ng-template>

  <!-- Crear comando -->
  <ion-card *ngIf="tieneTiposComandos">
    <ion-card-header>
      <ion-card-title>Crear Comando</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label>Tipo de Comando</ion-label>
        <ion-select [(ngModel)]="tipoSeleccionado" placeholder="Seleccionar tipo de comando">
          <ion-select-option *ngFor="let tipo of tiposComando" [value]="tipo">
            {{ tipo.descripcion }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Valor del Comando</ion-label>
        <ion-input [(ngModel)]="valorComando"></ion-input>
      </ion-item>

      <ion-button
        expand="block"
        color="primary"
        (click)="crearComando()"
        [disabled]="!tipoSeleccionado || !valorComando"
      >
        Crear Comando
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Última medición -->
  <ion-card *ngIf="ultimaMedicion">
    <ion-card-header>
      <ion-card-title>Última Medición</ion-card-title>
    </ion-card-header>
    <ion-card-content>

      
      <p><strong>Fecha: </strong> {{ ultimaMedicion.fecha | fechaLocal}}</p>
      <p><strong>Carril: </strong> {{ ultimaMedicion.carril }}</p>
      <p><strong>Clasificación: </strong> {{ ultimaMedicion.clasificacionDescripcion }}</p>
      <p><strong>Valor: </strong> {{ ultimaMedicion.valor }}</p>
    </ion-card-content>
    <ion-card-content>
      <ion-button expand="block" color="secondary" (click)="verMediciones()">
        Ver Mediciones
      </ion-button>
    </ion-card-content>
  </ion-card>

</ion-content>

<!-- Si el dispositivo aún no está cargado -->
<ion-content *ngIf="!dispositivo" class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Cargando...</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>Esperando datos del dispositivo...</p>
    </ion-card-content>
  </ion-card>
</ion-content>
